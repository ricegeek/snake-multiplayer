<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Retro Snakes - Collaborative Apple Hunt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            background: #0a0a1a;
            color: #e0e0ff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 10px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            padding: 15px;
        }
        
        .screen {
            display: none;
            text-align: center;
            padding: 20px;
            background: rgba(10, 10, 30, 0.8);
            border: 2px solid #4a4aff;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.5);
            width: 100%;
            max-width: 500px;
        }
        
        .active {
            display: block;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #ff4a4a;
            text-shadow: 0 0 10px rgba(255, 74, 74, 0.7);
            letter-spacing: 2px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin: 15px 0;
            color: #4aff4a;
            text-shadow: 0 0 10px rgba(74, 255, 74, 0.7);
        }
        
        .btn {
            background: #4a4aff;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 12px 8px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            width: 80%;
            max-width: 250px;
            box-shadow: 0 4px 0 #2a2a8f;
        }
        
        .btn:hover {
            background: #6a6aff;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #2a2a8f;
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #2a2a8f;
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 0 #333;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        
        .control-card {
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(30, 30, 60, 0.7);
            border: 2px solid #4a4aff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px;
        }
        
        .control-card.selected {
            background: rgba(74, 74, 255, 0.3);
            border-color: #ff4a4a;
            box-shadow: 0 0 15px rgba(255, 74, 74, 0.5);
        }
        
        .control-card:hover:not(.selected) {
            background: rgba(50, 50, 90, 0.8);
            transform: scale(1.03);
        }
        
        .control-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .control-label {
            font-size: 1rem;
            font-weight: bold;
        }
        
        .game-container {
            position: relative;
            margin: 15px auto;
            border: 3px solid #4a4aff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.5);
            width: 100%;
            max-width: 400px;
            aspect-ratio: 3/2;
        }
        
        canvas {
            background: #000;
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 1.1rem;
            padding: 0 10px;
        }
        
        .players-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
            max-height: 180px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .player-indicator {
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 1rem;
        }
        
        .player-1 { background: rgba(255, 74, 74, 0.3); }
        .player-2 { background: rgba(74, 255, 74, 0.3); }
        .player-3 { background: rgba(74, 74, 255, 0.3); }
        .player-4 { background: rgba(255, 255, 74, 0.3); }
        
        .instructions {
            background: rgba(20, 20, 40, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .instructions h3 {
            color: #4aff4a;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .instructions ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .instructions li {
            margin: 6px 0;
        }
        
        .retro-scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 1px,
                rgba(0, 0, 0, 0.1) 1px,
                rgba(0, 0, 0, 0.1) 2px
            );
            pointer-events: none;
            z-index: 10;
        }
        
        .share-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 30, 60, 0.5);
            border-radius: 10px;
        }
        
        .share-url {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a4aff;
            border-radius: 8px;
            color: #e0e0ff;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .status-message {
            margin: 12px 0;
            padding: 12px;
            background: rgba(74, 255, 74, 0.2);
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .error-message {
            background: rgba(255, 74, 74, 0.2);
        }
        
        .waiting-message {
            background: rgba(255, 255, 74, 0.2);
        }
        
        /* Game controls container */
        .game-controls-container {
            position: relative;
            width: 100%;
            margin-top: 15px;
        }
        
        /* Portrait mode controls (default) */
        .game-controls-portrait {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .direction-btn-portrait {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid #4a4aff;
            background: rgba(30, 30, 60, 0.8);
            color: white;
            font-size: 1.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 rgba(74, 74, 255, 0.3);
        }
        
        .direction-btn-portrait:active {
            transform: scale(0.95);
            box-shadow: 0 2px 0 rgba(74, 74, 255, 0.3);
        }
        
        /* Landscape mode controls */
        .game-controls-landscape {
            position: absolute;
            right: -100px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80px;
        }
        
        .direction-btn-landscape {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid #4a4aff;
            background: rgba(30, 30, 60, 0.8);
            color: white;
            font-size: 1.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 rgba(74, 74, 255, 0.3);
        }
        
        .direction-btn-landscape:active {
            transform: scale(0.95);
            box-shadow: 0 2px 0 rgba(74, 74, 255, 0.3);
        }
        
        .direction-btn-landscape.up { transform: rotate(0deg); }
        .direction-btn-landscape.down { transform: rotate(180deg); }
        .direction-btn-landscape.left { transform: rotate(270deg); }
        .direction-btn-landscape.right { transform: rotate(90deg); }
        
        .direction-btn-landscape.up:active { transform: rotate(0deg) scale(0.95); }
        .direction-btn-landscape.down:active { transform: rotate(180deg) scale(0.95); }
        .direction-btn-landscape.left:active { transform: rotate(270deg) scale(0.95); }
        .direction-btn-landscape.right:active { transform: rotate(90deg) scale(0.95); }
        
        /* Hide landscape controls by default */
        .game-controls-landscape {
            display: none;
        }
        
        /* Turn indicator */
        .turn-indicator {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 74, 0.2);
            border-radius: 8px;
            font-weight: bold;
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 500px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            .control-card { height: 85px; }
            .control-icon { font-size: 1.8rem; }
            .btn { padding: 12px; font-size: 1rem; }
            .player-indicator { padding: 8px; font-size: 0.95rem; }
            .direction-btn-portrait, .direction-btn-landscape { 
                width: 60px; 
                height: 60px; 
                font-size: 1.5rem; 
            }
        }
        
        /* Landscape orientation */
        @media (orientation: landscape) and (max-height: 500px) {
            .game-controls-portrait {
                display: none !important;
            }
            
            .game-controls-landscape {
                display: flex !important;
            }
            
            .game-container {
                max-width: 300px;
                aspect-ratio: 4/3;
            }
        }
        
        /* Desktop/laptop detection */
        @media (min-width: 768px) and (min-height: 600px) {
            .game-controls-portrait, .game-controls-landscape {
                /* Show both but position appropriately */
            }
        }
        
        /* iOS-specific fixes */
        @supports (-webkit-touch-callout: none) {
            .btn, .direction-btn-portrait, .direction-btn-landscape {
                -webkit-appearance: none;
            }
        }
        
        /* Prevent zoom on input focus */
        input {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <h1>RETRO SNAKES</h1>
            <p>Collaborative apple hunting with friends!</p>
            
            <div class="instructions">
                <h3>How to Play</h3>
                <ul>
                    <li>Create a game and share the link with friends</li>
                    <li>Each player assigns directions they control</li>
                    <li>Take turns controlling the snake in sequence</li>
                    <li>Collect apples without hitting walls or yourself</li>
                    <li>All players see the same game state!</li>
                </ul>
            </div>
            
            <button id="create-game-btn" class="btn">CREATE GAME</button>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <h2>GAME LOBBY</h2>
            
            <div class="share-section">
                <h3>Share this link:</h3>
                <input type="text" id="game-url" class="share-url" readonly>
                <button id="copy-url-btn" class="btn">COPY LINK</button>
            </div>
            
            <div id="status-message" class="status-message"></div>
            
            <p>Assign directions you want to control</p>
            
            <div class="controls">
                <div class="control-card" data-direction="up">
                    <div class="control-icon">↑</div>
                    <div class="control-label">UP</div>
                </div>
                <div class="control-card" data-direction="down">
                    <div class="control-icon">↓</div>
                    <div class="control-label">DOWN</div>
                </div>
                <div class="control-card" data-direction="left">
                    <div class="control-icon">←</div>
                    <div class="control-label">LEFT</div>
                </div>
                <div class="control-card" data-direction="right">
                    <div class="control-icon">→</div>
                    <div class="control-label">RIGHT</div>
                </div>
            </div>
            
            <div class="players-info">
                <div class="player-indicator player-1">Player 1: Not Assigned</div>
                <div class="player-indicator player-2">Player 2: Not Assigned</div>
                <div class="player-indicator player-3">Player 3: Not Assigned</div>
                <div class="player-indicator player-4">Player 4: Not Assigned</div>
            </div>
            
            <button id="start-btn" class="btn" disabled>START GAME</button>
            <button id="back-btn" class="btn">BACK</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>APPLE HUNT</h2>
            
            <div class="game-container">
                <canvas id="game-canvas"></canvas>
                <div class="retro-scanlines"></div>
            </div>
            
            <div class="turn-indicator" id="turn-indicator">Waiting for game to start...</div>
            
            <div class="game-controls-container">
                <!-- Portrait controls (bottom of screen) -->
                <div class="game-controls-portrait" id="game-controls-portrait">
                    <!-- Buttons will be added here dynamically -->
                </div>
                
                <!-- Landscape controls (right side of screen) -->
                <div class="game-controls-landscape" id="game-controls-landscape">
                    <!-- Buttons will be added here dynamically -->
                </div>
            </div>
            
            <div class="status-bar">
                <div>Apples: <span id="score">0</span></div>
                <div>Players: <span id="player-count">0</span>/4</div>
            </div>
            
            <button id="restart-btn" class="btn">RESTART</button>
        </div>
    </div>

    <script>
        // Game state with multiplayer support
        const gameState = {
            screen: 'home',
            gameId: null,
            isOwner: false,
            playerId: null,
            playerName: null,
            selectedDirections: {},
            score: 0,
            gameRunning: false,
            snake: [],
            apple: {x: 0, y: 0},
            direction: 'right',
            lastDirection: 'right',
            gridSize: 20,
            gameSpeed: 200, // Slower for turn-based gameplay
            canvasSize: { width: 400, height: 266 },
            currentTurn: 1,
            players: {},
            playerOrder: [],
            myAssignedDirections: []
        };
        
        // DOM Elements
        const screens = {
            home: document.getElementById('home-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };
        
        const buttons = {
            createGame: document.getElementById('create-game-btn'),
            start: document.getElementById('start-btn'),
            back: document.getElementById('back-btn'),
            restart: document.getElementById('restart-btn'),
            copyUrl: document.getElementById('copy-url-btn')
        };
        
        const controlCards = document.querySelectorAll('.control-card');
        const playerIndicators = document.querySelectorAll('.player-indicator');
        const scoreElement = document.getElementById('score');
        const playerCountElement = document.getElementById('player-count');
        const gameUrlInput = document.getElementById('game-url');
        const statusMessage = document.getElementById('status-message');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameControlsPortrait = document.getElementById('game-controls-portrait');
        const gameControlsLandscape = document.getElementById('game-controls-landscape');
        const turnIndicator = document.getElementById('turn-indicator');
        
        // Check if device is in landscape mode
        function isLandscape() {
            return window.matchMedia("(orientation: landscape)").matches && window.innerHeight < 500;
        }
        
        // Generate a unique game ID
        function generateGameId() {
            return Math.random().toString(36).substring(2, 10);
        }
        
        // Update URL with game ID
        function updateUrl(gameId) {
            const url = new URL(window.location);
            url.searchParams.set('game', gameId);
            window.history.pushState({}, '', url);
            gameUrlInput.value = url.toString();
        }
        
        // Initialize game
        function initGame(isOwner = false) {
            gameState.isOwner = isOwner;
            gameState.playerId = Date.now(); // Unique ID for each player
            gameState.playerName = `Player ${Math.floor(Math.random() * 1000) + 1}`;
            gameState.selectedDirections = {};
            gameState.score = 0;
            gameState.gameRunning = false;
            gameState.direction = 'right';
            gameState.lastDirection = 'right';
            gameState.currentTurn = 1;
            gameState.players = {};
            gameState.playerOrder = [];
            gameState.myAssignedDirections = [];
            
            // Reset UI
            controlCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            
            buttons.start.disabled = true;
            scoreElement.textContent = '0';
            playerCountElement.textContent = '0';
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
            gameControlsPortrait.innerHTML = '';
            gameControlsLandscape.innerHTML = '';
            turnIndicator.textContent = 'Waiting for game to start...';
        }
        
        // Show screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            gameState.screen = screenName;
            
            if (screenName === 'game') {
                setupCanvas();
                setupGameControls();
                startGame();
            }
        }
        
        // Assign direction to current player
        function assignDirection(direction) {
            if (gameState.selectedDirections[direction]) {
                delete gameState.selectedDirections[direction];
                statusMessage.textContent = `Unassigned ${direction.toUpperCase()}`;
            } else {
                gameState.selectedDirections[direction] = gameState.playerId;
                statusMessage.textContent = `Assigned ${direction.toUpperCase()} to yourself`;
            }
            
            const card = document.querySelector(`.control-card[data-direction="${direction}"]`);
            if (gameState.selectedDirections[direction]) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            
            updatePlayerIndicators();
            
            const assignedCount = Object.keys(gameState.selectedDirections).length;
            playerCountElement.textContent = assignedCount;
            
            if (assignedCount === 4) {
                buttons.start.disabled = false;
                statusMessage.textContent = 'All directions assigned! Tap START to begin.';
                statusMessage.className = 'status-message';
            } else {
                buttons.start.disabled = true;
                statusMessage.className = 'status-message';
            }
        }
        
        // Update player indicators
        function updatePlayerIndicators() {
            // Reset all indicators
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            
            // Group directions by player
            const playerDirections = {};
            for (const [direction, playerId] of Object.entries(gameState.selectedDirections)) {
                if (!playerDirections[playerId]) {
                    playerDirections[playerId] = [];
                }
                playerDirections[playerId].push(direction.toUpperCase());
            }
            
            // Update indicators for first 4 players
            let playerIndex = 0;
            for (const [playerId, directions] of Object.entries(playerDirections)) {
                if (playerIndex < 4) {
                    const indicator = playerIndicators[playerIndex];
                    indicator.textContent = `Player ${playerIndex + 1}: ${directions.join(', ')}`;
                    playerIndex++;
                }
            }
        }
        
        // Set up canvas
        function setupCanvas() {
            const container = canvas.parentElement;
            const displayWidth = container.clientWidth;
            const displayHeight = container.clientHeight;
            
            canvas.width = displayWidth * window.devicePixelRatio;
            canvas.height = displayHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }
        
        // Create a direction button
        function createDirectionButton(direction, isLandscape = false) {
            const btn = document.createElement('div');
            const className = isLandscape ? 'direction-btn-landscape' : 'direction-btn-portrait';
            btn.className = `${className} ${direction}`;
            btn.innerHTML = '↑';
            btn.dataset.direction = direction;
            btn.addEventListener('click', () => handleDirectionInput(direction));
            return btn;
        }
        
        // Set up game controls based on assigned directions and orientation
        function setupGameControls() {
            gameControlsPortrait.innerHTML = '';
            gameControlsLandscape.innerHTML = '';
            
            // Determine which directions this player controls
            gameState.myAssignedDirections = [];
            for (const [direction, playerId] of Object.entries(gameState.selectedDirections)) {
                if (playerId === gameState.playerId) {
                    gameState.myAssignedDirections.push(direction);
                }
            }
            
            // Create buttons for assigned directions
            const directions = ['up', 'down', 'left', 'right'];
            directions.forEach(dir => {
                if (gameState.myAssignedDirections.includes(dir)) {
                    // Portrait mode buttons (bottom of screen)
                    const portraitBtn = createDirectionButton(dir, false);
                    gameControlsPortrait.appendChild(portraitBtn);
                    
                    // Landscape mode buttons (right side)
                    const landscapeBtn = createDirectionButton(dir, true);
                    gameControlsLandscape.appendChild(landscapeBtn);
                }
            });
            
            if (gameState.myAssignedDirections.length === 0) {
                gameControlsPortrait.innerHTML = '<div style="color: #ff4a4a; padding: 10px;">You are not controlling any directions!</div>';
                gameControlsLandscape.innerHTML = '<div style="color: #ff4a4a; padding: 10px; width: 100%;">No controls</div>';
            }
        }
        
        // Handle direction input
        function handleDirectionInput(direction) {
            // Only allow input during player's turn
            if (gameState.currentTurn !== gameState.playerId) {
                return;
            }
            
            // Validate direction (prevent 180-degree turns)
            if ((direction === 'up' && gameState.lastDirection === 'down') ||
                (direction === 'down' && gameState.lastDirection === 'up') ||
                (direction === 'left' && gameState.lastDirection === 'right') ||
                (direction === 'right' && gameState.lastDirection === 'left')) {
                return;
            }
            
            // Set the direction
            gameState.direction = direction;
            gameState.lastDirection = direction;
            
            // Move to next player's turn
            const playerIds = Object.values(gameState.selectedDirections);
            const uniquePlayerIds = [...new Set(playerIds)];
            const currentIndex = uniquePlayerIds.indexOf(gameState.playerId);
            const nextIndex = (currentIndex + 1) % uniquePlayerIds.length;
            gameState.currentTurn = uniquePlayerIds[nextIndex];
            
            // Update turn indicator
            updateTurnIndicator();
        }
        
        // Update turn indicator
        function updateTurnIndicator() {
            if (gameState.currentTurn === gameState.playerId) {
                turnIndicator.textContent = 'Your turn! Use direction buttons or keyboard arrows.';
                turnIndicator.style.background = 'rgba(74, 255, 74, 0.3)';
            } else {
                turnIndicator.textContent = 'Waiting for other players...';
                turnIndicator.style.background = 'rgba(255, 255, 74, 0.2)';
            }
        }
        
        // Event Listeners
        buttons.createGame.addEventListener('click', () => {
            gameState.gameId = generateGameId();
            updateUrl(gameState.gameId);
            initGame(true);
            showScreen('lobby');
        });
        
        buttons.back.addEventListener('click', () => {
            showScreen('home');
        });
        
        buttons.restart.addEventListener('click', () => {
            showScreen('lobby');
        });
        
        buttons.copyUrl.addEventListener('click', () => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(gameUrlInput.value).then(() => {
                    statusMessage.textContent = 'Link copied to clipboard!';
                    statusMessage.className = 'status-message';
                }).catch(() => {
                    fallbackCopyTextToClipboard(gameUrlInput.value);
                });
            } else {
                fallbackCopyTextToClipboard(gameUrlInput.value);
            }
        });
        
        // Fallback copy for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    statusMessage.textContent = 'Link copied to clipboard!';
                    statusMessage.className = 'status-message';
                } else {
                    statusMessage.textContent = 'Failed to copy. Please copy manually.';
                    statusMessage.className = 'status-message error-message';
                }
            } catch (err) {
                statusMessage.textContent = 'Failed to copy. Please copy manually.';
                statusMessage.className = 'status-message error-message';
            }
            document.body.removeChild(textArea);
        }
        
        // Control selection
        controlCards.forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const direction = card.dataset.direction;
                assignDirection(direction);
            });
        });
        
        buttons.start.addEventListener('click', () => {
            if (Object.keys(gameState.selectedDirections).length === 4) {
                // Set up player order
                const playerIds = Object.values(gameState.selectedDirections);
                gameState.playerOrder = [...new Set(playerIds)];
                gameState.currentTurn = gameState.playerOrder[0];
                showScreen('game');
            }
        });
        
        // Handle URL parameters
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            }
        });
        
        // Handle browser navigation
        window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            } else {
                showScreen('home');
            }
        });
        
        // Handle window resize and orientation change
        window.addEventListener('resize', () => {
            if (gameState.screen === 'game') {
                setupCanvas();
                drawGame();
            }
        });
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (gameState.screen === 'game') {
                    setupCanvas();
                    drawGame();
                }
            }, 100);
        });
        
        // Game functions
        function initSnake() {
            const centerX = Math.floor(gameState.canvasSize.width / 2 / gameState.gridSize);
            const centerY = Math.floor(gameState.canvasSize.height / 2 / gameState.gridSize);
            gameState.snake = [
                {x: centerX, y: centerY},
                {x: centerX - 1, y: centerY},
                {x: centerX - 2, y: centerY}
            ];
        }
        
        function generateApple() {
            const maxX = Math.floor(gameState.canvasSize.width / gameState.gridSize) - 1;
            const maxY = Math.floor(gameState.canvasSize.height / gameState.gridSize) - 1;
            
            let newApple;
            let onSnake;
            
            do {
                onSnake = false;
                newApple = {
                    x: Math.floor(Math.random() * maxX),
                    y: Math.floor(Math.random() * maxY)
                };
                
                for (const segment of gameState.snake) {
                    if (segment.x === newApple.x && segment.y === newApple.y) {
                        onSnake = true;
                        break;
                    }
                }
            } while (onSnake);
            
            gameState.apple = newApple;
        }
        
        function drawSnake() {
            for (let i = 0; i < gameState.snake.length; i++) {
                const segment = gameState.snake[i];
                const isHead = i === 0;
                
                ctx.fillStyle = isHead ? '#ff4a4a' : '#4a4aff';
                ctx.fillRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
                
                ctx.strokeStyle = '#000';
                ctx.strokeRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
            }
        }
        
        function drawApple() {
            ctx.fillStyle = '#4aff4a';
            ctx.beginPath();
            ctx.arc(
                gameState.apple.x * gameState.gridSize + gameState.gridSize/2,
                gameState.apple.y * gameState.gridSize + gameState.gridSize/2,
                gameState.gridSize/2 - 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            ctx.fillStyle = '#aaffaa';
            ctx.beginPath();
            ctx.arc(
                gameState.apple.x * gameState.gridSize + gameState.gridSize/3,
                gameState.apple.y * gameState.gridSize + gameState.gridSize/3,
                gameState.gridSize/6,
                0,
                Math.PI * 2
            );
            ctx.fill();
        }
        
        function moveSnake() {
            if (!gameState.gameRunning) return;
            
            const head = {...gameState.snake[0]};
            
            switch(gameState.direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            const maxX = gameState.canvasSize.width / gameState.gridSize;
            const maxY = gameState.canvasSize.height / gameState.gridSize;
            
            if (head.x < 0 || head.x >= maxX || head.y < 0 || head.y >= maxY) {
                endGame();
                return;
            }
            
            for (let i = 0; i < gameState.snake.length; i++) {
                if (gameState.snake[i].x === head.x && gameState.snake[i].y === head.y) {
                    endGame();
                    return;
                }
            }
            
            gameState.snake.unshift(head);
            
            if (head.x === gameState.apple.x && head.y === gameState.apple.y) {
                gameState.score++;
                scoreElement.textContent = gameState.score;
                generateApple();
            } else {
                gameState.snake.pop();
            }
            
            // Update turn indicator
            updateTurnIndicator();
        }
        
        function drawGame() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, gameState.canvasSize.width, gameState.canvasSize.height);
            
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 0.5;
            for (let x = 0; x < gameState.canvasSize.width; x += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, gameState.canvasSize.height);
                ctx.stroke();
            }
            for (let y = 0; y < gameState.canvasSize.height; y += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(gameState.canvasSize.width, y);
                ctx.stroke();
            }
            
            drawApple();
            drawSnake();
        }
        
        function gameLoop() {
            moveSnake();
            drawGame();
            
            if (gameState.gameRunning) {
                setTimeout(gameLoop, gameState.gameSpeed);
            }
        }
        
        function startGame() {
            const container = canvas.parentElement;
            gameState.canvasSize.width = container.clientWidth;
            gameState.canvasSize.height = container.clientHeight;
            
            initSnake();
            generateApple();
            gameState.gameRunning = true;
            playerCountElement.textContent = '4';
            setupCanvas();
            setupGameControls();
            updateTurnIndicator();
            gameLoop();
        }
        
        function endGame() {
            gameState.gameRunning = false;
            setTimeout(() => {
                if (confirm(`Game Over! You collected ${gameState.score} apples!\nPlay again?`)) {
                    showScreen('lobby');
                } else {
                    showScreen('home');
                }
            }, 100);
        }
        
        // Keyboard controls for desktop
        document.addEventListener('keydown', (e) => {
            if (gameState.screen !== 'game') return;
            
            let direction;
            if (e.key === 'ArrowUp') direction = 'up';
            else if (e.key === 'ArrowDown') direction = 'down';
            else if (e.key === 'ArrowLeft') direction = 'left';
            else if (e.key === 'ArrowRight') direction = 'right';
            else return;
            
            // Check if this player controls this direction
            if (!gameState.myAssignedDirections.includes(direction)) return;
            
            handleDirectionInput(direction);
        });
    </script>
</body>
</html>
