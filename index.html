<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Retro Snakes - Collaborative Apple Hunt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            background: #0a0a1a;
            color: #e0e0ff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 10px;
            position: relative;
        }
        /* Animated background */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 30%, rgba(74, 74, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 74, 74, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(74, 255, 74, 0.1) 0%, transparent 50%);
            animation: bgMove 20s infinite alternate;
        }
        @keyframes bgMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        .container {
            width: 100%;
            max-width: 800px;
            padding: 15px;
        }
        .screen {
            display: none;
            text-align: center;
            padding: 20px;
            background: rgba(10, 10, 30, 0.85);
            border: 2px solid #4a4aff;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.5), 0 0 40px rgba(255, 74, 74, 0.3);
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }
        .active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #ff4a4a;
            text-shadow: 0 0 10px rgba(255, 74, 74, 0.7), 0 0 20px rgba(255, 74, 74, 0.5);
            letter-spacing: 2px;
            background: linear-gradient(45deg, #ff4a4a, #ff8a4a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        h2 {
            font-size: 1.8rem;
            margin: 15px 0;
            color: #4aff4a;
            text-shadow: 0 0 10px rgba(74, 255, 74, 0.7), 0 0 20px rgba(74, 255, 74, 0.5);
            letter-spacing: 1px;
        }
        .btn {
            background: linear-gradient(135deg, #4a4aff, #6a6aff);
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 12px 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            width: 80%;
            max-width: 250px;
            box-shadow: 0 4px 15px rgba(74, 74, 255, 0.4);
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 74, 255, 0.6);
        }
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(74, 74, 255, 0.4);
        }
        .btn:disabled {
            background: linear-gradient(135deg, #555, #666);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            opacity: 0.7;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        .control-card {
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(30, 30, 60, 0.7);
            border: 2px solid #4a4aff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .control-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(74, 74, 255, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.3s;
        }
        .control-card:hover::before {
            transform: translateX(0);
        }
        .control-card.selected {
            background: rgba(74, 74, 255, 0.4);
            border-color: #ff4a4a;
            box-shadow: 0 0 20px rgba(255, 74, 74, 0.6);
            transform: scale(1.05);
        }
        .control-card:hover:not(.selected) {
            background: rgba(50, 50, 90, 0.85);
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(74, 74, 255, 0.4);
        }
        .control-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .control-label {
            font-size: 1rem;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }
        .game-container {
            position: relative;
            margin: 15px auto;
            border: 3px solid #4a4aff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 25px rgba(74, 74, 255, 0.6), 0 0 50px rgba(255, 74, 74, 0.2);
            width: 100%;
            max-width: 400px;
            aspect-ratio: 3/2;
            background: #000;
        }
        canvas {
            background: #000;
            display: block;
            width: 100%;
            height: 100%;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 1.1rem;
            padding: 0 10px;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 8px;
            padding: 10px;
        }
        .players-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
            max-height: 180px;
            overflow-y: auto;
            padding: 5px;
            background: rgba(20, 20, 40, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(74, 74, 255, 0.3);
        }
        .player-indicator {
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .player-1 { background: rgba(255, 74, 74, 0.3); border: 1px solid rgba(255, 74, 74, 0.5); }
        .player-2 { background: rgba(74, 255, 74, 0.3); border: 1px solid rgba(74, 255, 74, 0.5); }
        .player-3 { background: rgba(74, 74, 255, 0.3); border: 1px solid rgba(74, 74, 255, 0.5); }
        .player-4 { background: rgba(255, 255, 74, 0.3); border: 1px solid rgba(255, 255, 74, 0.5); }
        .instructions {
            background: rgba(20, 20, 40, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
            line-height: 1.6;
            font-size: 0.95rem;
            border: 1px solid rgba(74, 74, 255, 0.3);
        }
        .instructions h3 {
            color: #4aff4a;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 0 0 10px rgba(74, 255, 74, 0.5);
        }
        .instructions ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .instructions li {
            margin: 8px 0;
            position: relative;
        }
        .instructions li::before {
            content: '•';
            color: #4aff4a;
            font-weight: bold;
            position: absolute;
            left: -15px;
        }
        .retro-scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 1px,
                rgba(0, 0, 0, 0.15) 1px,
                rgba(0, 0, 0, 0.15) 2px
            );
            pointer-events: none;
            z-index: 10;
            animation: scanline 8s linear infinite;
        }
        @keyframes scanline {
            0% { background-position: 0 0; }
            100% { background-position: 0 100px; }
        }
        .share-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 30, 60, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(74, 74, 255, 0.4);
        }
        .share-url {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #4a4aff;
            border-radius: 8px;
            color: #e0e0ff;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s;
        }
        .share-url:focus {
            border-color: #ff4a4a;
            box-shadow: 0 0 10px rgba(255, 74, 74, 0.5);
        }
        .status-message {
            margin: 12px 0;
            padding: 12px;
            background: rgba(74, 255, 74, 0.25);
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            border: 1px solid rgba(74, 255, 74, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .error-message {
            background: rgba(255, 74, 74, 0.25);
            border-color: rgba(255, 74, 74, 0.4);
        }
        .waiting-message {
            background: rgba(255, 255, 74, 0.25);
            border-color: rgba(255, 255, 74, 0.4);
        }
        .game-controls-container {
            position: relative;
            width: 100%;
            margin-top: 15px;
        }
        .game-controls-portrait {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        .direction-btn-portrait {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid #4a4aff;
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.9), rgba(50, 50, 100, 0.9));
            color: white;
            font-size: 1.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(74, 74, 255, 0.4);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .direction-btn-portrait:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(74, 74, 255, 0.3);
            background: linear-gradient(135deg, rgba(50, 50, 100, 0.9), rgba(30, 30, 60, 0.9));
        }
        .game-controls-landscape {
            position: absolute;
            right: -100px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80px;
        }
        .direction-btn-landscape {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid #4a4aff;
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.9), rgba(50, 50, 100, 0.9));
            color: white;
            font-size: 1.8rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(74, 74, 255, 0.4);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .direction-btn-landscape:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(74, 74, 255, 0.3);
        }
        .direction-btn-landscape.up { transform: rotate(0deg); }
        .direction-btn-landscape.down { transform: rotate(180deg); }
        .direction-btn-landscape.left { transform: rotate(270deg); }
        .direction-btn-landscape.right { transform: rotate(90deg); }
        .direction-btn-landscape.up:active { transform: rotate(0deg) scale(0.9); }
        .direction-btn-landscape.down:active { transform: rotate(180deg) scale(0.9); }
        .direction-btn-landscape.left:active { transform: rotate(270deg) scale(0.9); }
        .direction-btn-landscape.right:active { transform: rotate(90deg) scale(0.9); }
        .game-controls-landscape {
            display: none;
        }
        .turn-indicator {
            margin: 10px 0;
            padding: 12px;
            background: rgba(255, 255, 74, 0.25);
            border-radius: 8px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 74, 0.4);
            animation: glow 2s infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(255, 255, 74, 0.3); }
            to { box-shadow: 0 0 15px rgba(255, 255, 74, 0.6); }
        }
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            font-size: 10rem;
            color: #ff4a4a;
            text-shadow: 0 0 30px rgba(255, 74, 74, 0.9), 0 0 60px rgba(255, 74, 74, 0.7);
            font-weight: bold;
            letter-spacing: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        .countdown-overlay.active {
            opacity: 1;
        }
        /* Enhanced mobile adjustments */
        @media (max-width: 500px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            .control-card { height: 85px; }
            .control-icon { font-size: 1.8rem; }
            .btn { padding: 12px; font-size: 1rem; }
            .player-indicator { padding: 8px; font-size: 0.95rem; }
            .direction-btn-portrait, .direction-btn-landscape { 
                width: 60px; 
                height: 60px; 
                font-size: 1.5rem; 
            }
            .countdown-overlay {
                font-size: 8rem;
            }
            .status-bar {
                font-size: 1rem;
                padding: 8px;
            }
        }
        @media (orientation: landscape) and (max-height: 500px) {
            .game-controls-portrait {
                display: none !important;
            }
            .game-controls-landscape {
                display: flex !important;
            }
            .game-container {
                max-width: 300px;
                aspect-ratio: 4/3;
            }
        }
        @media (min-width: 768px) and (min-height: 600px) {
            .screen {
                transform: scale(1.05);
            }
        }
        @supports (-webkit-touch-callout: none) {
            .btn, .direction-btn-portrait, .direction-btn-landscape {
                -webkit-appearance: none;
            }
        }
        input {
            font-size: 16px;
        }
        /* Game over modal */
        .game-over-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 25;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .game-over-modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .game-over-content {
            background: rgba(10, 10, 30, 0.95);
            border: 2px solid #ff4a4a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 74, 74, 0.7);
            max-width: 400px;
            width: 90%;
        }
        .game-over-title {
            color: #ff4a4a;
            font-size: 2.2rem;
            margin-bottom: 15px;
            text-shadow: 0 0 15px rgba(255, 74, 74, 0.7);
        }
        .game-over-score {
            font-size: 1.5rem;
            margin: 15px 0;
            color: #4aff4a;
        }
        .modal-btns {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .modal-btn {
            padding: 12px 20px;
            font-size: 1rem;
            width: auto;
            max-width: none;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <h1>RETRO SNAKES</h1>
            <p>Collaborative apple hunting with friends!</p>
            <div class="instructions">
                <h3>How to Play</h3>
                <ul>
                    <li>Create a game and share the link with friends</li>
                    <li>Each player assigns directions they control</li>
                    <li>Take turns controlling the snake in sequence</li>
                    <li>Collect apples without hitting walls or yourself</li>
                    <li>All players see the same game state!</li>
                    <li>Compete for the highest apple collection!</li>
                </ul>
            </div>
            <button id="create-game-btn" class="btn">CREATE GAME</button>
        </div>
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <h2>GAME LOBBY</h2>
            <div class="share-section">
                <h3>Share this link:</h3>
                <input type="text" id="game-url" class="share-url" readonly>
                <button id="copy-url-btn" class="btn">COPY LINK</button>
            </div>
            <div id="status-message" class="status-message"></div>
            <p>Assign directions you want to control</p>
            <div class="controls">
                <div class="control-card" data-direction="up">
                    <div class="control-icon">↑</div>
                    <div class="control-label">UP</div>
                </div>
                <div class="control-card" data-direction="down">
                    <div class="control-icon">↓</div>
                    <div class="control-label">DOWN</div>
                </div>
                <div class="control-card" data-direction="left">
                    <div class="control-icon">←</div>
                    <div class="control-label">LEFT</div>
                </div>
                <div class="control-card" data-direction="right">
                    <div class="control-icon">→</div>
                    <div class="control-label">RIGHT</div>
                </div>
            </div>
            <div class="players-info">
                <div class="player-indicator player-1">Player 1: Not Assigned</div>
                <div class="player-indicator player-2">Player 2: Not Assigned</div>
                <div class="player-indicator player-3">Player 3: Not Assigned</div>
                <div class="player-indicator player-4">Player 4: Not Assigned</div>
            </div>
            <button id="start-btn" class="btn" disabled>START GAME</button>
            <button id="back-btn" class="btn">BACK</button>
        </div>
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>APPLE HUNT</h2>
            <div class="game-container">
                <canvas id="game-canvas"></canvas>
                <div class="retro-scanlines"></div>
                <div class="countdown-overlay" id="countdown-overlay">3</div>
                <div class="game-over-modal" id="game-over-modal">
                    <div class="game-over-content">
                        <div class="game-over-title">GAME OVER!</div>
                        <div class="game-over-score">Apples Collected: <span id="final-score">0</span></div>
                        <div class="modal-btns">
                            <button id="play-again-btn" class="btn modal-btn">PLAY AGAIN</button>
                            <button id="main-menu-btn" class="btn modal-btn">MAIN MENU</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="turn-indicator" id="turn-indicator">Waiting for game to start...</div>
            <div class="game-controls-container">
                <div class="game-controls-portrait" id="game-controls-portrait"></div>
                <div class="game-controls-landscape" id="game-controls-landscape"></div>
            </div>
            <div class="status-bar">
                <div>Apples: <span id="score">0</span></div>
                <div>Players: <span id="player-count">0</span>/4</div>
            </div>
        </div>
    </div>
    <script>
        // Enhanced game state
        const gameState = {
            screen: 'home',
            gameId: null,
            isOwner: false,
            playerId: null,
            playerName: null,
            selectedDirections: {},
            score: 0,
            gameRunning: false,
            snake: [],
            apple: {x: 0, y: 0},
            direction: 'right',
            lastDirection: 'right',
            gridSize: 20,
            gameSpeed: 200,
            canvasSize: { width: 400, height: 266 },
            currentTurn: 1,
            players: {},
            playerOrder: [],
            myAssignedDirections: [],
            countdownActive: false,
            gameOver: false
        };
        
        // DOM Elements
        const screens = {
            home: document.getElementById('home-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };
        const buttons = {
            createGame: document.getElementById('create-game-btn'),
            start: document.getElementById('start-btn'),
            back: document.getElementById('back-btn'),
            copyUrl: document.getElementById('copy-url-btn'),
            playAgain: document.getElementById('play-again-btn'),
            mainMenu: document.getElementById('main-menu-btn')
        };
        const controlCards = document.querySelectorAll('.control-card');
        const playerIndicators = document.querySelectorAll('.player-indicator');
        const scoreElement = document.getElementById('score');
        const playerCountElement = document.getElementById('player-count');
        const gameUrlInput = document.getElementById('game-url');
        const statusMessage = document.getElementById('status-message');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameControlsPortrait = document.getElementById('game-controls-portrait');
        const gameControlsLandscape = document.getElementById('game-controls-landscape');
        const turnIndicator = document.getElementById('turn-indicator');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreElement = document.getElementById('final-score');
        
        // Check if device is in landscape mode
        function isLandscape() {
            return window.matchMedia("(orientation: landscape)").matches && window.innerHeight < 500;
        }
        
        // Generate a unique game ID
        function generateGameId() {
            return Math.random().toString(36).substring(2, 10) + Date.now().toString(36).slice(-4);
        }
        
        // Update URL with game ID
        function updateUrl(gameId) {
            const url = new URL(window.location);
            url.searchParams.set('game', gameId);
            window.history.pushState({}, '', url);
            gameUrlInput.value = url.toString();
        }
        
        // Initialize game
        function initGame(isOwner = false) {
            gameState.isOwner = isOwner;
            gameState.playerId = Date.now() + Math.floor(Math.random() * 1000);
            gameState.playerName = `Player ${Math.floor(Math.random() * 1000) + 1}`;
            gameState.selectedDirections = {};
            gameState.score = 0;
            gameState.gameRunning = false;
            gameState.direction = 'right';
            gameState.lastDirection = 'right';
            gameState.currentTurn = 1;
            gameState.players = {};
            gameState.playerOrder = [];
            gameState.myAssignedDirections = [];
            gameState.countdownActive = false;
            gameState.gameOver = false;
            
            // Reset UI
            controlCards.forEach(card => {
                card.classList.remove('selected');
            });
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            buttons.start.disabled = true;
            scoreElement.textContent = '0';
            playerCountElement.textContent = '0';
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
            gameControlsPortrait.innerHTML = '';
            gameControlsLandscape.innerHTML = '';
            turnIndicator.textContent = 'Waiting for game to start...';
            countdownOverlay.textContent = '3';
            countdownOverlay.classList.remove('active');
            gameOverModal.classList.remove('active');
        }
        
        // Show screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            gameState.screen = screenName;
            if (screenName === 'game') {
                setupCanvas();
                setupGameControls();
                showCountdown();
            }
        }
        
        // Show 3-second countdown
        function showCountdown() {
            gameState.countdownActive = true;
            let count = 3;
            countdownOverlay.textContent = count;
            countdownOverlay.classList.add('active');
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownOverlay.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownOverlay.classList.remove('active');
                    gameState.countdownActive = false;
                    startGame();
                }
            }, 1000);
        }
        
        // Assign direction to current player
        function assignDirection(direction) {
            if (gameState.selectedDirections[direction]) {
                delete gameState.selectedDirections[direction];
                statusMessage.textContent = `Unassigned ${direction.toUpperCase()}`;
                statusMessage.className = 'status-message waiting-message';
            } else {
                gameState.selectedDirections[direction] = gameState.playerId;
                statusMessage.textContent = `Assigned ${direction.toUpperCase()} to yourself`;
                statusMessage.className = 'status-message';
            }
            
            const card = document.querySelector(`.control-card[data-direction="${direction}"]`);
            if (gameState.selectedDirections[direction]) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            
            updatePlayerIndicators();
            const assignedCount = Object.keys(gameState.selectedDirections).length;
            playerCountElement.textContent = assignedCount;
            
            if (assignedCount === 4) {
                buttons.start.disabled = false;
                statusMessage.textContent = 'All directions assigned! Tap START to begin.';
                statusMessage.className = 'status-message';
            } else {
                buttons.start.disabled = true;
                statusMessage.className = 'status-message';
            }
        }
        
        // Update player indicators
        function updatePlayerIndicators() {
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            
            const playerDirections = {};
            for (const [direction, playerId] of Object.entries(gameState.selectedDirections)) {
                if (!playerDirections[playerId]) {
                    playerDirections[playerId] = [];
                }
                playerDirections[playerId].push(direction.toUpperCase());
            }
            
            let playerIndex = 0;
            for (const [playerId, directions] of Object.entries(playerDirections)) {
                if (playerIndex < 4) {
                    const indicator = playerIndicators[playerIndex];
                    indicator.textContent = `Player ${playerIndex + 1}: ${directions.join(', ')}`;
                    playerIndex++;
                }
            }
        }
        
        // Set up canvas
        function setupCanvas() {
            const container = canvas.parentElement;
            const displayWidth = container.clientWidth;
            const displayHeight = container.clientHeight;
            canvas.width = displayWidth * window.devicePixelRatio;
            canvas.height = displayHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            gameState.canvasSize.width = displayWidth;
            gameState.canvasSize.height = displayHeight;
        }
        
        // Create a direction button
        function createDirectionButton(direction, isLandscape = false) {
            const btn = document.createElement('div');
            const className = isLandscape ? 'direction-btn-landscape' : 'direction-btn-portrait';
            btn.className = `${className} ${direction}`;
            btn.innerHTML = direction === 'up' ? '↑' : 
                           direction === 'down' ? '↓' : 
                           direction === 'left' ? '←' : '→';
            btn.dataset.direction = direction;
            btn.addEventListener('click', () => handleDirectionInput(direction));
            return btn;
        }
        
        // Set up game controls based on assigned directions and orientation
        function setupGameControls() {
            gameControlsPortrait.innerHTML = '';
            gameControlsLandscape.innerHTML = '';
            
            gameState.myAssignedDirections = [];
            for (const [direction, playerId] of Object.entries(gameState.selectedDirections)) {
                if (playerId === gameState.playerId) {
                    gameState.myAssignedDirections.push(direction);
                }
            }
            
            const directions = ['up', 'down', 'left', 'right'];
            directions.forEach(dir => {
                if (gameState.myAssignedDirections.includes(dir)) {
                    const portraitBtn = createDirectionButton(dir, false);
                    gameControlsPortrait.appendChild(portraitBtn);
                    const landscapeBtn = createDirectionButton(dir, true);
                    gameControlsLandscape.appendChild(landscapeBtn);
                }
            });
            
            if (gameState.myAssignedDirections.length === 0) {
                gameControlsPortrait.innerHTML = '<div style="color: #ff4a4a; padding: 10px;">You are not controlling any directions!</div>';
                gameControlsLandscape.innerHTML = '<div style="color: #ff4a4a; padding: 10px; width: 100%;">No controls</div>';
            }
        }
        
        // Handle direction input
        function handleDirectionInput(direction) {
            if (gameState.countdownActive || gameState.gameOver) return;
            if (gameState.currentTurn !== gameState.playerId) return;
            
            if ((direction === 'up' && gameState.lastDirection === 'down') ||
                (direction === 'down' && gameState.lastDirection === 'up') ||
                (direction === 'left' && gameState.lastDirection === 'right') ||
                (direction === 'right' && gameState.lastDirection === 'left')) {
                return;
            }
            
            gameState.direction = direction;
            gameState.lastDirection = direction;
            
            const playerIds = Object.values(gameState.selectedDirections);
            const uniquePlayerIds = [...new Set(playerIds)];
            const currentIndex = uniquePlayerIds.indexOf(gameState.playerId);
            const nextIndex = (currentIndex + 1) % uniquePlayerIds.length;
            gameState.currentTurn = uniquePlayerIds[nextIndex];
            
            updateTurnIndicator();
        }
        
        // Update turn indicator
        function updateTurnIndicator() {
            if (gameState.currentTurn === gameState.playerId) {
                turnIndicator.textContent = 'Your turn! Use direction buttons or keyboard arrows.';
                turnIndicator.style.background = 'rgba(74, 255, 74, 0.35)';
                turnIndicator.style.borderColor = 'rgba(74, 255, 74, 0.5)';
            } else {
                turnIndicator.textContent = 'Waiting for other players...';
                turnIndicator.style.background = 'rgba(255, 255, 74, 0.25)';
                turnIndicator.style.borderColor = 'rgba(255, 255, 74, 0.4)';
            }
        }
        
        // Event Listeners
        buttons.createGame.addEventListener('click', () => {
            gameState.gameId = generateGameId();
            updateUrl(gameState.gameId);
            initGame(true);
            showScreen('lobby');
        });
        
        buttons.back.addEventListener('click', () => {
            showScreen('home');
        });
        
        buttons.copyUrl.addEventListener('click', () => {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(gameUrlInput.value).then(() => {
                    statusMessage.textContent = 'Link copied to clipboard!';
                    statusMessage.className = 'status-message';
                }).catch(() => {
                    fallbackCopyTextToClipboard(gameUrlInput.value);
                });
            } else {
                fallbackCopyTextToClipboard(gameUrlInput.value);
            }
        });
        
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    statusMessage.textContent = 'Link copied to clipboard!';
                    statusMessage.className = 'status-message';
                } else {
                    statusMessage.textContent = 'Failed to copy. Please copy manually.';
                    statusMessage.className = 'status-message error-message';
                }
            } catch (err) {
                statusMessage.textContent = 'Failed to copy. Please copy manually.';
                statusMessage.className = 'status-message error-message';
            }
            document.body.removeChild(textArea);
        }
        
        controlCards.forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const direction = card.dataset.direction;
                assignDirection(direction);
            });
        });
        
        buttons.start.addEventListener('click', () => {
            if (Object.keys(gameState.selectedDirections).length === 4) {
                const playerIds = Object.values(gameState.selectedDirections);
                gameState.playerOrder = [...new Set(playerIds)];
                gameState.currentTurn = gameState.playerOrder[0];
                showScreen('game');
            }
        });
        
        // Game over modal buttons
        buttons.playAgain.addEventListener('click', () => {
            showScreen('lobby');
        });
        
        buttons.mainMenu.addEventListener('click', () => {
            showScreen('home');
        });
        
        // Handle URL parameters
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            }
        });
        
        window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            } else {
                showScreen('home');
            }
        });
        
        window.addEventListener('resize', () => {
            if (gameState.screen === 'game') {
                setupCanvas();
                drawGame();
            }
        });
        
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (gameState.screen === 'game') {
                    setupCanvas();
                    drawGame();
                }
            }, 100);
        });
        
        // Enhanced game functions
        function initSnake() {
            const centerX = Math.floor(gameState.canvasSize.width / 2 / gameState.gridSize);
            const centerY = Math.floor(gameState.canvasSize.height / 2 / gameState.gridSize);
            gameState.snake = [
                {x: centerX, y: centerY},
                {x: centerX - 1, y: centerY},
                {x: centerX - 2, y: centerY}
            ];
        }
        
        function generateApple() {
            const maxX = Math.floor(gameState.canvasSize.width / gameState.gridSize) - 1;
            const maxY = Math.floor(gameState.canvasSize.height / gameState.gridSize) - 1;
            let newApple;
            let onSnake;
            do {
                onSnake = false;
                newApple = {
                    x: Math.floor(Math.random() * maxX),
                    y: Math.floor(Math.random() * maxY)
                };
                for (const segment of gameState.snake) {
                    if (segment.x === newApple.x && segment.y === newApple.y) {
                        onSnake = true;
                        break;
                    }
                }
            } while (onSnake);
            gameState.apple = newApple;
        }
        
        function drawSnake() {
            for (let i = 0; i < gameState.snake.length; i++) {
                const segment = gameState.snake[i];
                const isHead = i === 0;
                const gradient = ctx.createLinearGradient(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    segment.x * gameState.gridSize + gameState.gridSize, 
                    segment.y * gameState.gridSize + gameState.gridSize
                );
                
                if (isHead) {
                    gradient.addColorStop(0, '#ff6a6a');
                    gradient.addColorStop(1, '#ff4a4a');
                    ctx.fillStyle = gradient;
                } else {
                    gradient.addColorStop(0, '#6a6aff');
                    gradient.addColorStop(1, '#4a4aff');
                    ctx.fillStyle = gradient;
                }
                
                ctx.fillRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.strokeRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
            }
        }
        
        function drawApple() {
            const centerX = gameState.apple.x * gameState.gridSize + gameState.gridSize/2;
            const centerY = gameState.apple.y * gameState.gridSize + gameState.gridSize/2;
            const radius = gameState.gridSize/2 - 2;
            
            const gradient = ctx.createRadialGradient(
                centerX - radius/3, centerY - radius/3, 0,
                centerX, centerY, radius
            );
            gradient.addColorStop(0, '#aaffaa');
            gradient.addColorStop(0.7, '#4aff4a');
            gradient.addColorStop(1, '#2a8a2a');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Apple stem
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(centerX - 2, centerY - radius - 4, 4, 6);
            
            // Apple leaf
            ctx.fillStyle = '#4aff4a';
            ctx.beginPath();
            ctx.ellipse(centerX + 6, centerY - radius - 2, 4, 2, Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function moveSnake() {
            if (!gameState.gameRunning || gameState.gameOver) return;
            
            const head = {...gameState.snake[0]};
            switch(gameState.direction) {
                case 'up': head.y--; break;
                case 'down': head.y++; break;
                case 'left': head.x--; break;
                case 'right': head.x++; break;
            }
            
            const maxX = gameState.canvasSize.width / gameState.gridSize;
            const maxY = gameState.canvasSize.height / gameState.gridSize;
            
            if (head.x < 0 || head.x >= maxX || head.y < 0 || head.y >= maxY) {
                endGame();
                return;
            }
            
            for (let i = 0; i < gameState.snake.length; i++) {
                if (gameState.snake[i].x === head.x && gameState.snake[i].y === head.y) {
                    endGame();
                    return;
                }
            }
            
            gameState.snake.unshift(head);
            
            if (head.x === gameState.apple.x && head.y === gameState.apple.y) {
                gameState.score++;
                scoreElement.textContent = gameState.score;
                generateApple();
                // Speed up slightly with each apple (but not too much for turn-based)
                if (gameState.gameSpeed > 100) {
                    gameState.gameSpeed = Math.max(100, gameState.gameSpeed - 2);
                }
            } else {
                gameState.snake.pop();
            }
            
            updateTurnIndicator();
        }
        
        function drawGame() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, gameState.canvasSize.width, gameState.canvasSize.height);
            
            // Draw grid with subtle animation
            ctx.strokeStyle = 'rgba(74, 74, 255, 0.1)';
            ctx.lineWidth = 0.5;
            for (let x = 0; x < gameState.canvasSize.width; x += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, gameState.canvasSize.height);
                ctx.stroke();
            }
            for (let y = 0; y < gameState.canvasSize.height; y += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(gameState.canvasSize.width, y);
                ctx.stroke();
            }
            
            drawApple();
            drawSnake();
        }
        
        function gameLoop() {
            moveSnake();
            drawGame();
            if (gameState.gameRunning && !gameState.gameOver) {
                setTimeout(gameLoop, gameState.gameSpeed);
            }
        }
        
        function startGame() {
            initSnake();
            generateApple();
            gameState.gameRunning = true;
            gameState.gameOver = false;
            playerCountElement.textContent = '4';
            setupCanvas();
            setupGameControls();
            updateTurnIndicator();
            gameLoop();
        }
        
        function endGame() {
            gameState.gameRunning = false;
            gameState.gameOver = true;
            finalScoreElement.textContent = gameState.score;
            setTimeout(() => {
                gameOverModal.classList.add('active');
            }, 300);
        }
        
        // Keyboard controls for desktop
        document.addEventListener('keydown', (e) => {
            if (gameState.screen !== 'game' || gameState.countdownActive || gameState.gameOver) return;
            
            let direction;
            if (e.key === 'ArrowUp') direction = 'up';
            else if (e.key === 'ArrowDown') direction = 'down';
            else if (e.key === 'ArrowLeft') direction = 'left';
            else if (e.key === 'ArrowRight') direction = 'right';
            else return;
            
            if (!gameState.myAssignedDirections.includes(direction)) return;
            handleDirectionInput(direction);
        });
        
        // Prevent context menu on mobile
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
