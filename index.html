<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Snakes - Collaborative Apple Hunt</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: #0a0a1a;
            color: #e0e0ff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        
        .screen {
            display: none;
            text-align: center;
            padding: 30px;
            background: rgba(10, 10, 30, 0.8);
            border: 2px solid #4a4aff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.5);
        }
        
        .active {
            display: block;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: #ff4a4a;
            text-shadow: 0 0 10px rgba(255, 74, 74, 0.7);
            letter-spacing: 3px;
        }
        
        h2 {
            font-size: 2rem;
            margin: 20px 0;
            color: #4aff4a;
            text-shadow: 0 0 10px rgba(74, 255, 74, 0.7);
        }
        
        .btn {
            background: #4a4aff;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #6a6aff;
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(74, 74, 255, 0.8);
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }
        
        .control-card {
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(30, 30, 60, 0.7);
            border: 2px solid #4a4aff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .control-card.selected {
            background: rgba(74, 74, 255, 0.3);
            border-color: #ff4a4a;
            box-shadow: 0 0 15px rgba(255, 74, 74, 0.5);
        }
        
        .control-card:hover:not(.selected) {
            background: rgba(50, 50, 90, 0.8);
            transform: scale(1.05);
        }
        
        .control-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .control-label {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .game-container {
            position: relative;
            margin: 20px auto;
            border: 3px solid #4a4aff;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(74, 74, 255, 0.5);
        }
        
        canvas {
            background: #000;
            display: block;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 1.2rem;
            padding: 0 10px;
        }
        
        .players-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .player-indicator {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 150px;
        }
        
        .player-1 { background: rgba(255, 74, 74, 0.3); }
        .player-2 { background: rgba(74, 255, 74, 0.3); }
        .player-3 { background: rgba(74, 74, 255, 0.3); }
        .player-4 { background: rgba(255, 255, 74, 0.3); }
        
        .instructions {
            background: rgba(20, 20, 40, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
            line-height: 1.6;
        }
        
        .instructions h3 {
            color: #4aff4a;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        .retro-scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                transparent,
                transparent 1px,
                rgba(0, 0, 0, 0.1) 1px,
                rgba(0, 0, 0, 0.1) 2px
            );
            pointer-events: none;
            z-index: 10;
        }
        
        .share-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(30, 30, 60, 0.5);
            border-radius: 8px;
        }
        
        .share-url {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a4aff;
            border-radius: 5px;
            color: #e0e0ff;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .status-message {
            margin: 15px 0;
            padding: 10px;
            background: rgba(74, 255, 74, 0.2);
            border-radius: 5px;
            font-weight: bold;
        }
        
        .error-message {
            background: rgba(255, 74, 74, 0.2);
        }
        
        .waiting-message {
            background: rgba(255, 255, 74, 0.2);
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            h2 { font-size: 1.5rem; }
            .control-card { width: 100px; height: 100px; }
            .btn { padding: 10px 20px; font-size: 1rem; }
            .player-indicator { min-width: 120px; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <h1>RETRO SNAKES</h1>
            <p>Collaborative apple hunting with friends!</p>
            
            <div class="instructions">
                <h3>How to Play</h3>
                <ul>
                    <li>Create a game and share the unique URL with friends</li>
                    <li>Each player controls one or more directions: UP, DOWN, LEFT, or RIGHT</li>
                    <li>Work together to guide the snake to collect apples</li>
                    <li>All 4 directions must be assigned before starting</li>
                    <li>You can assign all directions to yourself for solo play!</li>
                </ul>
            </div>
            
            <button id="create-game-btn" class="btn">CREATE GAME</button>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen">
            <h2>GAME LOBBY</h2>
            
            <div class="share-section">
                <h3>Share this URL with friends:</h3>
                <input type="text" id="game-url" class="share-url" readonly>
                <button id="copy-url-btn" class="btn">COPY LINK</button>
            </div>
            
            <div id="status-message" class="status-message"></div>
            
            <p>Assign directions to yourself. All 4 directions must be assigned to start.</p>
            
            <div class="controls">
                <div class="control-card" data-direction="up">
                    <div class="control-icon">↑</div>
                    <div class="control-label">UP</div>
                </div>
                <div class="control-card" data-direction="down">
                    <div class="control-icon">↓</div>
                    <div class="control-label">DOWN</div>
                </div>
                <div class="control-card" data-direction="left">
                    <div class="control-icon">←</div>
                    <div class="control-label">LEFT</div>
                </div>
                <div class="control-card" data-direction="right">
                    <div class="control-icon">→</div>
                    <div class="control-label">RIGHT</div>
                </div>
            </div>
            
            <div class="players-info">
                <div class="player-indicator player-1">Player 1: Not Assigned</div>
                <div class="player-indicator player-2">Player 2: Not Assigned</div>
                <div class="player-indicator player-3">Player 3: Not Assigned</div>
                <div class="player-indicator player-4">Player 4: Not Assigned</div>
            </div>
            
            <button id="start-btn" class="btn" disabled>START GAME</button>
            <button id="back-btn" class="btn">BACK</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>APPLE HUNT</h2>
            
            <div class="game-container">
                <canvas id="game-canvas" width="600" height="400"></canvas>
                <div class="retro-scanlines"></div>
            </div>
            
            <div class="status-bar">
                <div>Apples: <span id="score">0</span></div>
                <div>Players: <span id="player-count">0</span>/4</div>
            </div>
            
            <button id="restart-btn" class="btn">RESTART</button>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            screen: 'home',
            gameId: null,
            isOwner: false,
            playerId: 1, // Owner is always player 1
            selectedDirections: {},
            score: 0,
            gameRunning: false,
            snake: [],
            apple: {x: 0, y: 0},
            direction: 'right',
            lastDirection: 'right',
            gridSize: 20,
            gameSpeed: 120
        };
        
        // DOM Elements
        const screens = {
            home: document.getElementById('home-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };
        
        const buttons = {
            createGame: document.getElementById('create-game-btn'),
            start: document.getElementById('start-btn'),
            back: document.getElementById('back-btn'),
            restart: document.getElementById('restart-btn'),
            copyUrl: document.getElementById('copy-url-btn')
        };
        
        const controlCards = document.querySelectorAll('.control-card');
        const playerIndicators = document.querySelectorAll('.player-indicator');
        const scoreElement = document.getElementById('score');
        const playerCountElement = document.getElementById('player-count');
        const gameUrlInput = document.getElementById('game-url');
        const statusMessage = document.getElementById('status-message');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Generate a unique game ID
        function generateGameId() {
            return Math.random().toString(36).substring(2, 10);
        }
        
        // Update URL with game ID
        function updateUrl(gameId) {
            const url = new URL(window.location);
            url.searchParams.set('game', gameId);
            window.history.pushState({}, '', url);
            gameUrlInput.value = url.toString();
        }
        
        // Initialize game
        function initGame(isOwner = false) {
            // Reset game state
            gameState.isOwner = isOwner;
            gameState.playerId = 1; // Owner is always player 1
            gameState.selectedDirections = {};
            gameState.score = 0;
            gameState.gameRunning = false;
            gameState.direction = 'right';
            gameState.lastDirection = 'right';
            
            // Reset UI
            controlCards.forEach(card => {
                card.classList.remove('selected');
                card.style.opacity = '1';
            });
            
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            
            buttons.start.disabled = true;
            scoreElement.textContent = '0';
            playerCountElement.textContent = '0';
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
        }
        
        // Show screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            gameState.screen = screenName;
            
            if (screenName === 'game') {
                startGame();
            }
        }
        
        // Assign direction to current player
        function assignDirection(direction) {
            // Toggle assignment
            if (gameState.selectedDirections[direction]) {
                // Unassign direction
                delete gameState.selectedDirections[direction];
                statusMessage.textContent = `Unassigned ${direction.toUpperCase()}`;
            } else {
                // Assign direction to current player
                gameState.selectedDirections[direction] = gameState.playerId;
                statusMessage.textContent = `Assigned ${direction.toUpperCase()} to Player ${gameState.playerId}`;
            }
            
            // Update UI
            const card = document.querySelector(`.control-card[data-direction="${direction}"]`);
            if (gameState.selectedDirections[direction]) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
            
            // Update player indicators
            updatePlayerIndicators();
            
            // Check if all directions are assigned
            const assignedCount = Object.keys(gameState.selectedDirections).length;
            playerCountElement.textContent = assignedCount;
            
            if (assignedCount === 4) {
                buttons.start.disabled = false;
                statusMessage.textContent = 'All directions assigned! Click START to begin.';
                statusMessage.className = 'status-message';
            } else {
                buttons.start.disabled = true;
                statusMessage.className = 'status-message';
            }
        }
        
        // Update player indicators based on assignments
        function updatePlayerIndicators() {
            // Reset all indicators
            playerIndicators.forEach(indicator => {
                indicator.textContent = `${indicator.textContent.split(':')[0]}: Not Assigned`;
            });
            
            // Group directions by player
            const playerDirections = {};
            for (const [direction, playerId] of Object.entries(gameState.selectedDirections)) {
                if (!playerDirections[playerId]) {
                    playerDirections[playerId] = [];
                }
                playerDirections[playerId].push(direction.toUpperCase());
            }
            
            // Update indicators
            for (const [playerId, directions] of Object.entries(playerDirections)) {
                const indicator = playerIndicators[playerId - 1];
                indicator.textContent = `Player ${playerId}: ${directions.join(', ')}`;
            }
        }
        
        // Event Listeners
        buttons.createGame.addEventListener('click', () => {
            gameState.gameId = generateGameId();
            updateUrl(gameState.gameId);
            initGame(true);
            showScreen('lobby');
        });
        
        buttons.back.addEventListener('click', () => {
            showScreen('home');
        });
        
        buttons.restart.addEventListener('click', () => {
            showScreen('lobby');
        });
        
        buttons.copyUrl.addEventListener('click', () => {
            gameUrlInput.select();
            document.execCommand('copy');
            statusMessage.textContent = 'Link copied to clipboard!';
            statusMessage.className = 'status-message';
        });
        
        // Control selection
        controlCards.forEach(card => {
            card.addEventListener('click', () => {
                const direction = card.dataset.direction;
                assignDirection(direction);
            });
        });
        
        buttons.start.addEventListener('click', () => {
            if (Object.keys(gameState.selectedDirections).length === 4) {
                showScreen('game');
            }
        });
        
        // Handle URL parameters on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                
                // For joined players, we'll keep them as Player 1 for simplicity
                // In a real implementation, you'd assign unique player IDs
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            }
        });
        
        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            
            if (gameId) {
                gameState.gameId = gameId;
                gameUrlInput.value = window.location.href;
                initGame(false);
                showScreen('lobby');
                statusMessage.textContent = 'Joined game! Assign directions to control.';
                statusMessage.className = 'status-message';
            } else {
                showScreen('home');
            }
        });
        
        // Game functions
        function initSnake() {
            const centerX = Math.floor(canvas.width / 2 / gameState.gridSize);
            const centerY = Math.floor(canvas.height / 2 / gameState.gridSize);
            gameState.snake = [
                {x: centerX, y: centerY},
                {x: centerX - 1, y: centerY},
                {x: centerX - 2, y: centerY}
            ];
        }
        
        function generateApple() {
            const maxX = Math.floor(canvas.width / gameState.gridSize) - 1;
            const maxY = Math.floor(canvas.height / gameState.gridSize) - 1;
            
            let newApple;
            let onSnake;
            
            do {
                onSnake = false;
                newApple = {
                    x: Math.floor(Math.random() * maxX),
                    y: Math.floor(Math.random() * maxY)
                };
                
                // Check if apple is on snake
                for (const segment of gameState.snake) {
                    if (segment.x === newApple.x && segment.y === newApple.y) {
                        onSnake = true;
                        break;
                    }
                }
            } while (onSnake);
            
            gameState.apple = newApple;
        }
        
        function drawSnake() {
            // Draw snake body
            for (let i = 0; i < gameState.snake.length; i++) {
                const segment = gameState.snake[i];
                const isHead = i === 0;
                
                ctx.fillStyle = isHead ? '#ff4a4a' : '#4a4aff';
                ctx.fillRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
                
                // Add retro effect
                ctx.strokeStyle = '#000';
                ctx.strokeRect(
                    segment.x * gameState.gridSize, 
                    segment.y * gameState.gridSize, 
                    gameState.gridSize, 
                    gameState.gridSize
                );
            }
        }
        
        function drawApple() {
            ctx.fillStyle = '#4aff4a';
            ctx.beginPath();
            ctx.arc(
                gameState.apple.x * gameState.gridSize + gameState.gridSize/2,
                gameState.apple.y * gameState.gridSize + gameState.gridSize/2,
                gameState.gridSize/2 - 2,
                0,
                Math.PI * 2
            );
            ctx.fill();
            
            // Add shine effect
            ctx.fillStyle = '#aaffaa';
            ctx.beginPath();
            ctx.arc(
                gameState.apple.x * gameState.gridSize + gameState.gridSize/3,
                gameState.apple.y * gameState.gridSize + gameState.gridSize/3,
                gameState.gridSize/6,
                0,
                Math.PI * 2
            );
            ctx.fill();
        }
        
        function moveSnake() {
            if (!gameState.gameRunning) return;
            
            // Create new head based on direction
            const head = {...gameState.snake[0]};
            
            switch(gameState.direction) {
                case 'up':
                    head.y--;
                    break;
                case 'down':
                    head.y++;
                    break;
                case 'left':
                    head.x--;
                    break;
                case 'right':
                    head.x++;
                    break;
            }
            
            // Check wall collision
            const maxX = canvas.width / gameState.gridSize;
            const maxY = canvas.height / gameState.gridSize;
            
            if (head.x < 0 || head.x >= maxX || head.y < 0 || head.y >= maxY) {
                endGame();
                return;
            }
            
            // Check self collision
            for (let i = 0; i < gameState.snake.length; i++) {
                if (gameState.snake[i].x === head.x && gameState.snake[i].y === head.y) {
                    endGame();
                    return;
                }
            }
            
            // Add new head
            gameState.snake.unshift(head);
            
            // Check apple collision
            if (head.x === gameState.apple.x && head.y === gameState.apple.y) {
                // Increase score
                gameState.score++;
                scoreElement.textContent = gameState.score;
                
                // Generate new apple
                generateApple();
            } else {
                // Remove tail if no apple eaten
                gameState.snake.pop();
            }
            
            gameState.lastDirection = gameState.direction;
        }
        
        function drawGame() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 0.5;
            for (let x = 0; x < canvas.width; x += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gameState.gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            drawApple();
            drawSnake();
        }
        
        function gameLoop() {
            moveSnake();
            drawGame();
            
            if (gameState.gameRunning) {
                setTimeout(gameLoop, gameState.gameSpeed);
            }
        }
        
        function startGame() {
            initSnake();
            generateApple();
            gameState.gameRunning = true;
            playerCountElement.textContent = '4';
            gameLoop();
        }
        
        function endGame() {
            gameState.gameRunning = false;
            setTimeout(() => {
                alert(`Game Over! You collected ${gameState.score} apples!`);
                showScreen('lobby');
            }, 100);
        }
        
        // Keyboard controls for demo purposes
        document.addEventListener('keydown', (e) => {
            if (gameState.screen !== 'game') return;
            
            // Prevent direction reversal
            if (gameState.direction === 'up' && e.key === 'ArrowDown') return;
            if (gameState.direction === 'down' && e.key === 'ArrowUp') return;
            if (gameState.direction === 'left' && e.key === 'ArrowRight') return;
            if (gameState.direction === 'right' && e.key === 'ArrowLeft') return;
            
            switch(e.key) {
                case 'ArrowUp':
                    gameState.direction = 'up';
                    break;
                case 'ArrowDown':
                    gameState.direction = 'down';
                    break;
                case 'ArrowLeft':
                    gameState.direction = 'left';
                    break;
                case 'ArrowRight':
                    gameState.direction = 'right';
                    break;
            }
        });
    </script>
</body>
</html>

